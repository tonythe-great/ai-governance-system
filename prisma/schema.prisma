// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  REVIEWER
  ADMIN
}

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  name            String?
  password        String
  role            UserRole  @default(USER)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  submissions     AISystemSubmission[]

  // Review relations
  assignedReviews SubmissionReview[] @relation("ReviewerAssignments")
  reviewComments  ReviewComment[]
  reviewActions   ReviewAction[]
}

model AISystemSubmission {
  id                      String    @id @default(cuid())

  // Section 1 - Basic Information
  aiSystemName            String?
  useCase                 String?
  businessPurpose         String?
  vendor                  String?
  currentStage            String?
  numberOfUsers           String?

  // Section 2 - Human Oversight
  outputUsage             String?
  humanReviewLevel        String?

  // Section 3 - Data & Privacy
  dataTypes               String[]  @default([])
  vendorDataStorage       String?
  userTrainingRequired    Boolean   @default(false)
  acceptableUseRequired   Boolean   @default(false)

  // Section 4 - Ownership & Accountability
  executiveSponsorName    String?
  executiveSponsorTitle   String?
  businessOwnerName       String?
  businessOwnerEmail      String?
  technicalOwnerName      String?
  technicalOwnerEmail     String?

  // Section 5 - Compliance & Monitoring
  hasFederalContracts     String?
  usageLoggingEnabled     Boolean   @default(false)
  complianceAccess        Boolean   @default(false)
  incidentResponseDoc     Boolean   @default(false)

  // Metadata
  status                  String    @default("DRAFT")
  submittedBy             User?     @relation(fields: [submittedById], references: [id])
  submittedById           String?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  submittedAt             DateTime?

  // Risk Assessment
  riskAssessment          RiskAssessment?

  // Submission Review
  review                  SubmissionReview?

  @@index([submittedById])
  @@index([status])
}

model RiskAssessment {
  id              String   @id @default(cuid())
  submissionId    String   @unique
  submission      AISystemSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  // Scores (0-100, higher = more risk)
  overallScore        Int
  overallLevel        String   // LOW, MEDIUM, HIGH, CRITICAL

  // Category scores
  dataPrivacyScore    Int
  oversightScore      Int
  complianceScore     Int
  vendorScore         Int

  // Risk flags identified
  riskFlags           String[]

  // LLM-generated content
  summary             String   // 2-3 sentence summary
  recommendations     String[] // Action items
  explanation         String   @db.Text // Detailed analysis (markdown)

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model DropdownOption {
  id        String   @id @default(cuid())
  category  String
  value     String
  label     String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([category, value])
  @@index([category])
}

model SubmissionReview {
  id              String   @id @default(cuid())
  submissionId    String   @unique
  submission      AISystemSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  // Reviewer assignment
  assignedToId    String?
  assignedTo      User?    @relation("ReviewerAssignments", fields: [assignedToId], references: [id])
  assignedAt      DateTime?

  // Review metadata
  priority        String   @default("NORMAL")
  dueDate         DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  comments        ReviewComment[]
  actions         ReviewAction[]

  @@index([assignedToId])
  @@index([priority])
}

model ReviewComment {
  id              String   @id @default(cuid())
  reviewId        String
  review          SubmissionReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  authorId        String
  author          User     @relation(fields: [authorId], references: [id])

  content         String   @db.Text
  isInternal      Boolean  @default(false)

  // For section-specific comments
  sectionName     String?
  fieldName       String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([reviewId])
  @@index([authorId])
}

model ReviewAction {
  id              String   @id @default(cuid())
  reviewId        String
  review          SubmissionReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  performedById   String
  performedBy     User     @relation(fields: [performedById], references: [id])

  action          String   // ASSIGNED, APPROVED, REJECTED, CHANGES_REQUESTED, COMMENT_ADDED, STATUS_CHANGED
  previousStatus  String?
  newStatus       String?
  notes           String?  @db.Text

  createdAt       DateTime @default(now())

  @@index([reviewId])
  @@index([performedById])
  @@index([createdAt])
}
